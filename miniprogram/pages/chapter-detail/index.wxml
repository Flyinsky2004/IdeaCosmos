<view class="container">
  <!-- 加载状态 -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">正在加载章节内容...</text>
  </view>

  <block wx:elif="{{chapter}}">

    <!-- 章节内容 -->
    <view class="chapter-container">
      <!-- 章节头部信息 -->
      <view class="chapter-header">
        <view class="page-title-container">
          <view class="title-indicator"></view>
          <text class="chapter-title">{{chapter.Title}}</text>
        </view>
        <text class="chapter-desc">{{chapter.Description}}</text>
        
        <view class="chapter-meta">
          <view class="meta-item">
            <text class="meta-icon">📅</text>
            <text class="meta-text">创建于 {{chapter.CreatedAt}}</text>
          </view>
          <view class="meta-item">
            <text class="meta-icon">✏️</text>
            <text class="meta-text">最后更新 {{chapter.UpdatedAt}}</text>
          </view>
          <view class="meta-item">
            <text class="meta-icon">📝</text>
            <text class="meta-text">字数统计：{{chapter.current_version.content.length}}</text>
          </view>
        </view>
      </view>

      <!-- 音频播放器 -->
      <view class="audio-player" wx:if="{{chapter.current_version.audio_path}}">
        <view class="audio-header">
          <text class="audio-icon">🎵</text>
          <text class="audio-title">章节音频</text>
        </view>
        
        <!-- 自定义音频控制器 -->
        <view class="custom-audio-player">
          <!-- 隐藏的原生audio组件用于实际播放 -->
          <audio 
            src="{{audioUrl}}"
            id="myAudio"
            bindplay="onAudioPlay"
            bindpause="onAudioPause"
            bindtimeupdate="onAudioTimeUpdate"
            bindended="onAudioEnded"
            binderror="onAudioError">
          </audio>
          
          <!-- 播放控制按钮 -->
          <view class="audio-controls">
            <!-- 快退15秒 -->
            <view class="control-btn rewind-btn" bindtap="rewindAudio">
              <text class="control-icon">⏪</text>
              <text class="control-text">15s</text>
            </view>
            
            <!-- 播放/暂停按钮 -->
            <view class="control-btn play-btn {{isPlaying ? 'playing' : ''}}" bindtap="togglePlayAudio">
              <text class="control-icon">{{isPlaying ? '⏸' : '▶️'}}</text>
            </view>
            
            <!-- 快进15秒 -->
            <view class="control-btn forward-btn" bindtap="forwardAudio">
              <text class="control-icon">⏩</text>
              <text class="control-text">15s</text>
            </view>
          </view>
          
          <!-- 进度条 -->
          <view class="progress-container">
            <text class="time-text">{{currentTimeText}}</text>
            <view class="progress-bar-container">
              <slider 
                class="progress-slider" 
                min="0" 
                max="{{audioDuration}}" 
                value="{{currentTime}}"
                activeColor="#3b82f6"
                backgroundColor="rgba(63, 63, 70, 0.6)"
                block-size="12"
                block-color="#06b6d4"
                bindchange="onSliderChange"
                bindchanging="onSliderChanging"
              />
            </view>
            <text class="time-text">{{durationText}}</text>
          </view>
          
          <!-- 播放速度控制 -->
          <view class="playback-rate">
            <text class="rate-label">播放速度:</text>
            <view class="rate-buttons">
              <view 
                wx:for="{{playbackRates}}" 
                wx:key="value"
                class="rate-btn {{currentRate === item.value ? 'active' : ''}}"
                bindtap="changePlaybackRate"
                data-rate="{{item.value}}">
                {{item.label}}
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- 正文内容 -->
      <view class="content-container">
        <!-- 字体大小控制 -->
        <view class="font-control">
          <text>字体大小</text>
          <view class="font-buttons">
            <view 
              wx:for="{{fontSizes}}" 
              wx:key="value"
              class="font-btn {{currentFontSize === item.value ? 'active' : ''}}"
              bindtap="changeFontSize"
              data-size="{{item.value}}">
              {{item.label}}
            </view>
          </view>
        </view>

        <!-- 使用富文本组件显示内容 -->
        <rich-text 
          nodes="{{chapter.current_version.content}}" 
          class="chapter-content {{currentFontSize}}"
        ></rich-text>
      </view>

      <!-- 情绪评价 -->
      <view class="emotion-section">
        <view class="section-title-container">
          <view class="title-indicator"></view>
          <text class="section-title">你对本篇剧情感受如何？</text>
        </view>
        <text class="section-subtitle">选择一个最能代表你此刻感受的情绪</text>

        <view wx:if="{{userFeeling}}" class="selected-emotion">
          <text>你的感受是:</text>
          <view class="emotion-tag">
            <text class="emotion-icon">{{emotionMap[userFeeling.feeling].icon}}</text>
            <text>{{userFeeling.feeling}}</text>
          </view>
        </view>

        <view wx:else class="emotions-grid">
          <view 
            wx:for="{{emotions}}" 
            wx:key="name"
            class="emotion-item {{selectedEmotion === item.name ? 'selected' : ''}}"
            bindtap="submitFeeling"
            data-emotion="{{item.name}}">
            <text class="emotion-icon">{{item.icon}}</text>
            <text class="emotion-name">{{item.name}}</text>
            <text class="emotion-desc">{{item.description}}</text>
          </view>
        </view>
      </view>

      <!-- 评论区域 -->
      <view class="comments-section">
        <view class="section-title-container">
          <view class="title-indicator"></view>
          <text class="section-title">读者评论</text>
        </view>

        <!-- 评论输入框 -->
        <view class="comment-input">
          <textarea
            placeholder="分享你的想法..."
            value="{{commentContent}}"
            bindinput="onCommentInput"
            disabled="{{!isLoggedIn}}"
          ></textarea>
          <button class="submit-btn" bindtap="submitComment" disabled="{{!isLoggedIn}}">
            发表评论
          </button>
          <text wx:if="{{!isLoggedIn}}" class="login-tip">
            请先 <text class="login-link" bindtap="navigateToLogin">登录</text> 后再评论
          </text>
        </view>

        <!-- 评论类型切换 -->
        <view class="comment-types">
          <view 
            wx:for="{{commentTypes}}" 
            wx:key="value"
            class="type-btn {{commentType === item.value ? 'active' : ''}}"
            bindtap="changeCommentType"
            data-type="{{item.value}}">
            {{item.label}}
          </view>
        </view>

        <!-- 评论列表 -->
        <view class="comments-list">
          <view wx:if="{{comments.length === 0}}" class="no-comments">
            还没有评论，快来发表第一条评论吧！
          </view>

          <view 
            wx:for="{{comments}}" 
            wx:key="id" 
            class="comment-item">
            <image class="commenter-avatar" src="{{'https://idea.1024110.xyz/api/'+item.user.avatar || '/images/default-avatar.png'}}" mode="aspectFill"></image>
            <view class="comment-content">
              <view class="comment-header">
                <text class="commenter-name">{{item.user.nickname || item.user.username}}</text>
                <text wx:if="{{item.type === 'author'}}" class="author-tag">作者</text>
              </view>
              <text class="comment-text">{{item.Content}}</text>
              <text class="comment-time">{{formatDate(item.CreatedAt)}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </block>

  <!-- 错误状态 -->
  <view class="error-container" wx:else>
    <view class="empty-state">
      <text class="empty-icon">📚</text>
      <text class="empty-text">章节不存在或已被删除</text>
      <text class="empty-subtext">请返回项目页面查看其他章节</text>
    </view>
  </view>
</view> 