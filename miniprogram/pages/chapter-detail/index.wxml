<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <loading-spinner />
  </view>

  <block wx:elif="{{chapter}}">
    <!-- å¯¼èˆªæ  -->
    <view class="nav-bar">
      <view class="back-btn" bindtap="navigateBack">
        <text class="back-icon">â†</text>
        <text>è¿”å›é¡¹ç›®</text>
      </view>
      <text class="project-name">{{project.project_name}}</text>
    </view>

    <!-- ç« èŠ‚å†…å®¹ -->
    <view class="chapter-container">
      <!-- ç« èŠ‚å¤´éƒ¨ä¿¡æ¯ -->
      <view class="chapter-header">
        <text class="chapter-title">{{chapter.Title}}</text>
        <text class="chapter-desc">{{chapter.Description}}</text>
        
        <view class="chapter-meta">
          <view class="meta-item">
            <text class="meta-icon">ğŸ“…</text>
            <text class="meta-text">åˆ›å»ºäº {{formatDate(chapter.CreatedAt)}}</text>
          </view>
          <view class="meta-item">
            <text class="meta-icon">âœï¸</text>
            <text class="meta-text">æœ€åæ›´æ–° {{formatDate(chapter.UpdatedAt)}}</text>
          </view>
          <view class="meta-item">
            <text class="meta-icon">ğŸ“</text>
            <text class="meta-text">å­—æ•°ç»Ÿè®¡ï¼š{{chapter.current_version.content.length}}</text>
          </view>
        </view>
      </view>

      <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
      <view class="audio-player" wx:if="{{chapter.current_version.audio_path}}">
        <view class="audio-header">
          <text class="audio-icon">ğŸµ</text>
          <text class="audio-title">ç« èŠ‚éŸ³é¢‘</text>
        </view>
        <audio 
          src="{{audioUrl}}"
          id="myAudio"
          controls
          bindplay="onAudioPlay"
          binderror="onAudioError">
        </audio>
      </view>

      <!-- æ­£æ–‡å†…å®¹ -->
      <view class="content-container">
        <!-- å­—ä½“å¤§å°æ§åˆ¶ -->
        <view class="font-control">
          <text>å­—ä½“å¤§å°</text>
          <view class="font-buttons">
            <view 
              wx:for="{{fontSizes}}" 
              wx:key="value"
              class="font-btn {{currentFontSize === item.value ? 'active' : ''}}"
              bindtap="changeFontSize"
              data-size="{{item.value}}">
              {{item.label}}
            </view>
          </view>
        </view>

        <!-- ä½¿ç”¨å¯Œæ–‡æœ¬ç»„ä»¶æ˜¾ç¤ºå†…å®¹ -->
        <rich-text 
          nodes="{{parsedContent}}" 
          class="chapter-content {{currentFontSize}}"
        ></rich-text>
      </view>

      <!-- æƒ…ç»ªè¯„ä»· -->
      <view class="emotion-section">
        <text class="section-title">ä½ å¯¹æœ¬ç¯‡å‰§æƒ…æ„Ÿå—å¦‚ä½•ï¼Ÿ</text>
        <text class="section-subtitle">é€‰æ‹©ä¸€ä¸ªæœ€èƒ½ä»£è¡¨ä½ æ­¤åˆ»æ„Ÿå—çš„æƒ…ç»ª</text>

        <view wx:if="{{userFeeling}}" class="selected-emotion">
          <text>ä½ çš„æ„Ÿå—æ˜¯:</text>
          <view class="emotion-tag">
            <text class="emotion-icon">{{emotionMap[userFeeling.feeling].icon}}</text>
            <text>{{userFeeling.feeling}}</text>
          </view>
        </view>

        <view wx:else class="emotions-grid">
          <view 
            wx:for="{{emotions}}" 
            wx:key="name"
            class="emotion-item {{selectedEmotion === item.name ? 'selected' : ''}}"
            bindtap="submitFeeling"
            data-emotion="{{item.name}}">
            <text class="emotion-icon">{{item.icon}}</text>
            <text class="emotion-name">{{item.name}}</text>
            <text class="emotion-desc">{{item.description}}</text>
          </view>
        </view>
      </view>

      <!-- è¯„è®ºåŒºåŸŸ -->
      <view class="comments-section">
        <text class="section-title">è¯»è€…è¯„è®º</text>

        <!-- è¯„è®ºè¾“å…¥æ¡† -->
        <view class="comment-input">
          <textarea
            placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..."
            value="{{commentContent}}"
            bindinput="onCommentInput"
            disabled="{{!isLoggedIn}}"
          ></textarea>
          <button class="submit-btn" bindtap="submitComment" disabled="{{!isLoggedIn}}">
            å‘è¡¨è¯„è®º
          </button>
          <text wx:if="{{!isLoggedIn}}" class="login-tip">
            è¯·å…ˆ <text class="login-link" bindtap="navigateToLogin">ç™»å½•</text> åå†è¯„è®º
          </text>
        </view>

        <!-- è¯„è®ºç±»å‹åˆ‡æ¢ -->
        <view class="comment-types">
          <view 
            wx:for="{{commentTypes}}" 
            wx:key="value"
            class="type-btn {{commentType === item.value ? 'active' : ''}}"
            bindtap="changeCommentType"
            data-type="{{item.value}}">
            {{item.label}}
          </view>
        </view>

        <!-- è¯„è®ºåˆ—è¡¨ -->
        <view class="comments-list">
          <view wx:if="{{comments.length === 0}}" class="no-comments">
            è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼
          </view>

          <view 
            wx:for="{{comments}}" 
            wx:key="id" 
            class="comment-item">
            <image class="commenter-avatar" src="{{item.user.avatar || '/images/default-avatar.png'}}" mode="aspectFill"></image>
            <view class="comment-content">
              <view class="comment-header">
                <text class="commenter-name">{{item.user.nickname || item.user.username}}</text>
                <text wx:if="{{item.type === 'author'}}" class="author-tag">ä½œè€…</text>
              </view>
              <text class="comment-text">{{item.Content}}</text>
              <text class="comment-time">{{formatDate(item.CreatedAt)}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </block>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view class="error-container" wx:else>
    <text>ç« èŠ‚ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤</text>
  </view>
</view> 