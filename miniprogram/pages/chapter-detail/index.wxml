<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">æ­£åœ¨åŠ è½½ç« èŠ‚å†…å®¹...</text>
  </view>

  <block wx:elif="{{chapter}}">

    <!-- ç« èŠ‚å†…å®¹ -->
    <view class="chapter-container">
      <!-- ç« èŠ‚å¤´éƒ¨ä¿¡æ¯ -->
      <view class="chapter-header">
        <view class="page-title-container">
          <view class="title-indicator"></view>
          <text class="chapter-title">{{chapter.Title}}</text>
        </view>
        <text class="chapter-desc">{{chapter.Description}}</text>
        
        <view class="chapter-meta">
          <view class="meta-item">
            <text class="meta-icon">ğŸ“…</text>
            <text class="meta-text">åˆ›å»ºäº {{chapter.CreatedAt}}</text>
          </view>
          <view class="meta-item">
            <text class="meta-icon">âœï¸</text>
            <text class="meta-text">æœ€åæ›´æ–° {{chapter.UpdatedAt}}</text>
          </view>
          <view class="meta-item">
            <text class="meta-icon">ğŸ“</text>
            <text class="meta-text">å­—æ•°ç»Ÿè®¡ï¼š{{chapter.current_version.content.length}}</text>
          </view>
        </view>
      </view>

      <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
      <view class="audio-player" wx:if="{{chapter.current_version.audio_path}}">
        <view class="audio-header">
          <text class="audio-icon">ğŸµ</text>
          <text class="audio-title">ç« èŠ‚éŸ³é¢‘</text>
        </view>
        
        <!-- è‡ªå®šä¹‰éŸ³é¢‘æ§åˆ¶å™¨ -->
        <view class="custom-audio-player">
          <!-- éšè—çš„åŸç”Ÿaudioç»„ä»¶ç”¨äºå®é™…æ’­æ”¾ -->
          <audio 
            src="{{audioUrl}}"
            id="myAudio"
            bindplay="onAudioPlay"
            bindpause="onAudioPause"
            bindtimeupdate="onAudioTimeUpdate"
            bindended="onAudioEnded"
            binderror="onAudioError">
          </audio>
          
          <!-- æ’­æ”¾æ§åˆ¶æŒ‰é’® -->
          <view class="audio-controls">
            <!-- å¿«é€€15ç§’ -->
            <view class="control-btn rewind-btn" bindtap="rewindAudio">
              <text class="control-icon">âª</text>
              <text class="control-text">15s</text>
            </view>
            
            <!-- æ’­æ”¾/æš‚åœæŒ‰é’® -->
            <view class="control-btn play-btn {{isPlaying ? 'playing' : ''}}" bindtap="togglePlayAudio">
              <text class="control-icon">{{isPlaying ? 'â¸' : 'â–¶ï¸'}}</text>
            </view>
            
            <!-- å¿«è¿›15ç§’ -->
            <view class="control-btn forward-btn" bindtap="forwardAudio">
              <text class="control-icon">â©</text>
              <text class="control-text">15s</text>
            </view>
          </view>
          
          <!-- è¿›åº¦æ¡ -->
          <view class="progress-container">
            <text class="time-text">{{currentTimeText}}</text>
            <view class="progress-bar-container">
              <slider 
                class="progress-slider" 
                min="0" 
                max="{{audioDuration}}" 
                value="{{currentTime}}"
                activeColor="#3b82f6"
                backgroundColor="rgba(63, 63, 70, 0.6)"
                block-size="12"
                block-color="#06b6d4"
                bindchange="onSliderChange"
                bindchanging="onSliderChanging"
              />
            </view>
            <text class="time-text">{{durationText}}</text>
          </view>
          
          <!-- æ’­æ”¾é€Ÿåº¦æ§åˆ¶ -->
          <view class="playback-rate">
            <text class="rate-label">æ’­æ”¾é€Ÿåº¦:</text>
            <view class="rate-buttons">
              <view 
                wx:for="{{playbackRates}}" 
                wx:key="value"
                class="rate-btn {{currentRate === item.value ? 'active' : ''}}"
                bindtap="changePlaybackRate"
                data-rate="{{item.value}}">
                {{item.label}}
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- æ­£æ–‡å†…å®¹ -->
      <view class="content-container">
        <!-- å­—ä½“å¤§å°æ§åˆ¶ -->
        <view class="font-control">
          <text>å­—ä½“å¤§å°</text>
          <view class="font-buttons">
            <view 
              wx:for="{{fontSizes}}" 
              wx:key="value"
              class="font-btn {{currentFontSize === item.value ? 'active' : ''}}"
              bindtap="changeFontSize"
              data-size="{{item.value}}">
              {{item.label}}
            </view>
          </view>
        </view>

        <!-- ä½¿ç”¨å¯Œæ–‡æœ¬ç»„ä»¶æ˜¾ç¤ºå†…å®¹ -->
        <rich-text 
          nodes="{{chapter.current_version.content}}" 
          class="chapter-content {{currentFontSize}}"
        ></rich-text>
      </view>

      <!-- æƒ…ç»ªè¯„ä»· -->
      <view class="emotion-section">
        <view class="section-title-container">
          <view class="title-indicator"></view>
          <text class="section-title">ä½ å¯¹æœ¬ç¯‡å‰§æƒ…æ„Ÿå—å¦‚ä½•ï¼Ÿ</text>
        </view>
        <text class="section-subtitle">é€‰æ‹©ä¸€ä¸ªæœ€èƒ½ä»£è¡¨ä½ æ­¤åˆ»æ„Ÿå—çš„æƒ…ç»ª</text>

        <view wx:if="{{userFeeling}}" class="selected-emotion">
          <text>ä½ çš„æ„Ÿå—æ˜¯:</text>
          <view class="emotion-tag">
            <text class="emotion-icon">{{emotionMap[userFeeling.feeling].icon}}</text>
            <text>{{userFeeling.feeling}}</text>
          </view>
        </view>

        <view wx:else class="emotions-grid">
          <view 
            wx:for="{{emotions}}" 
            wx:key="name"
            class="emotion-item {{selectedEmotion === item.name ? 'selected' : ''}}"
            bindtap="submitFeeling"
            data-emotion="{{item.name}}">
            <text class="emotion-icon">{{item.icon}}</text>
            <text class="emotion-name">{{item.name}}</text>
            <text class="emotion-desc">{{item.description}}</text>
          </view>
        </view>
      </view>

      <!-- è¯„è®ºåŒºåŸŸ -->
      <view class="comments-section">
        <view class="section-title-container">
          <view class="title-indicator"></view>
          <text class="section-title">è¯»è€…è¯„è®º</text>
        </view>

        <!-- è¯„è®ºè¾“å…¥æ¡† -->
        <view class="comment-input">
          <textarea
            placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..."
            value="{{commentContent}}"
            bindinput="onCommentInput"
            disabled="{{!isLoggedIn}}"
          ></textarea>
          <button class="submit-btn" bindtap="submitComment" disabled="{{!isLoggedIn}}">
            å‘è¡¨è¯„è®º
          </button>
          <text wx:if="{{!isLoggedIn}}" class="login-tip">
            è¯·å…ˆ <text class="login-link" bindtap="navigateToLogin">ç™»å½•</text> åå†è¯„è®º
          </text>
        </view>

        <!-- è¯„è®ºç±»å‹åˆ‡æ¢ -->
        <view class="comment-types">
          <view 
            wx:for="{{commentTypes}}" 
            wx:key="value"
            class="type-btn {{commentType === item.value ? 'active' : ''}}"
            bindtap="changeCommentType"
            data-type="{{item.value}}">
            {{item.label}}
          </view>
        </view>

        <!-- è¯„è®ºåˆ—è¡¨ -->
        <view class="comments-list">
          <view wx:if="{{comments.length === 0}}" class="no-comments">
            è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼
          </view>

          <view 
            wx:for="{{comments}}" 
            wx:key="id" 
            class="comment-item">
            <image class="commenter-avatar" src="{{'https://idea.1024110.xyz/api/'+item.user.avatar || '/images/default-avatar.png'}}" mode="aspectFill"></image>
            <view class="comment-content">
              <view class="comment-header">
                <text class="commenter-name">{{item.user.nickname || item.user.username}}</text>
                <text wx:if="{{item.type === 'author'}}" class="author-tag">ä½œè€…</text>
              </view>
              <text class="comment-text">{{item.Content}}</text>
              <text class="comment-time">{{formatDate(item.CreatedAt)}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </block>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view class="error-container" wx:else>
    <view class="empty-state">
      <text class="empty-icon">ğŸ“š</text>
      <text class="empty-text">ç« èŠ‚ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤</text>
      <text class="empty-subtext">è¯·è¿”å›é¡¹ç›®é¡µé¢æŸ¥çœ‹å…¶ä»–ç« èŠ‚</text>
    </view>
  </view>
</view> 