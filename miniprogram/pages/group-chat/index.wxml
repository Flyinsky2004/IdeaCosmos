<!-- 群组聊天页面 -->
<view class="chat-container">
  <!-- 顶部导航栏 -->
  <view class="header">
    <view class="group-info">
      <view class="group-avatar">
        <image wx:if="{{groupInfo.AvatarURL}}" src="{{groupInfo.AvatarURL}}" mode="aspectFill"></image>
        <view wx:else class="default-avatar">{{groupInfo.Name[0]}}</view>
      </view>
      <view class="group-name">{{groupInfo.Name}}</view>
    </view>
    <view class="member-count">{{groupInfo.MemberCount || 0}}人</view>
  </view>

  <!-- 消息列表 -->
  <scroll-view 
    scroll-y 
    class="messages-list" 
    scroll-into-view="{{scrollToMessage}}"
    bindscrolltoupper="loadMoreMessages"
    enhanced="{{true}}"
    show-scrollbar="{{false}}"
    scroll-anchoring="{{true}}"
  >
    <!-- 加载更多提示 -->
    <view wx:if="{{loading}}" class="loading-more">
      <view class="loading-spinner"></view>
      <text>加载中...</text>
    </view>

    <!-- 消息列表 -->
    <block wx:for="{{messages}}" wx:key="ID">
      <!-- 系统消息（加入/离开提示） -->
      <view wx:if="{{item.type === 'join' || item.type === 'leave'}}" class="system-message">
        <view class="system-message-content">
          <view class="system-icon {{item.type === 'join' ? 'join-icon' : 'leave-icon'}}"></view>
          <text>{{item.Content}}</text>
          <text class="message-time">{{formatTime(item.CreatedAt)}}</text>
        </view>
      </view>

      <!-- 普通聊天消息 -->
      <view 
        wx:else 
        id="msg-{{item.ID}}"
        class="message-item {{item.SenderID === userInfo.id ? 'self-message' : ''}}"
      >
        <!-- 发送者头像 -->
        <view class="avatar-container">
          <image 
            wx:if="{{item.senderAvatar}}" 
            src="{{item.senderAvatar}}" 
            class="avatar" 
            mode="aspectFill"
          ></image>
          <view wx:else class="default-avatar">{{item.senderName[0] || '?'}}</view>
        </view>

        <!-- 消息内容 -->
        <view class="message-content {{item.SenderID === userInfo.id ? 'self-content' : ''}}">
          <!-- 发送者名称 -->
          <view wx:if="{{item.SenderID !== userInfo.id}}" class="sender-name">
            {{item.senderName}}
            <text class="message-time-inline">{{formatTime(item.CreatedAt)}}</text>
          </view>

          <!-- 文本消息 -->
          <view wx:if="{{item.MediaType === 'text'}}" class="text-message">
            {{item.Content}}
          </view>

          <!-- 图片消息 -->
          <view wx:elif="{{item.MediaType === 'image'}}" class="image-message">
            <image 
              src="{{item.MediaURL}}" 
              mode="widthFix" 
              class="message-image" 
              bindtap="previewImage" 
              data-url="{{item.MediaURL}}"
            ></image>
          </view>

          <!-- 音频消息 -->
          <view wx:elif="{{item.MediaType === 'audio'}}" class="audio-message">
            <view class="audio-icon"></view>
            <text class="audio-text">语音消息</text>
            <view class="audio-player">
              <audio src="{{item.MediaURL}}" id="audio-{{item.ID}}" controls></audio>
            </view>
          </view>

          <!-- 视频消息 -->
          <view wx:elif="{{item.MediaType === 'video'}}" class="video-message">
            <view class="video-header">
              <view class="video-icon"></view>
              <text class="video-text">视频消息</text>
            </view>
            <video 
              src="{{item.MediaURL}}" 
              class="message-video" 
              controls
            ></video>
          </view>

          <!-- 发送时间 (仅自己的消息) -->
          <view wx:if="{{item.SenderID === userInfo.id}}" class="message-time self-time">
            {{formatTime(item.CreatedAt)}}
          </view>
        </view>
      </view>
    </block>

    <!-- 无消息提示 -->
    <view wx:if="{{messages.length === 0 && !loading}}" class="no-messages">
      <view class="no-messages-icon"></view>
      <view class="no-messages-text">开始聊天吧</view>
      <view class="no-messages-subtext">发送消息开始与群组成员交流</view>
    </view>
  </scroll-view>

  <!-- 连接状态提示 -->
  <view wx:if="{{!isConnected}}" class="connection-status">
    <view class="connection-dot"></view>
    <text>正在连接...</text>
  </view>

  <!-- 输入区域 -->
  <view class="input-area">
    <!-- 媒体预览 -->
    <view wx:if="{{mediaPreview}}" class="media-preview">
      <image 
        wx:if="{{mediaType === 'image'}}" 
        src="{{mediaPreview}}" 
        mode="aspectFit" 
        class="preview-image"
      ></image>
      <view wx:else class="file-preview">
        <view class="file-icon"></view>
        <text class="file-name">{{mediaFile.name}}</text>
      </view>
      <view class="cancel-media" bindtap="cancelMediaSelect">×</view>
    </view>

    <view class="input-controls">
      <!-- 媒体上传按钮 -->
      <view class="media-button" bindtap="chooseMedia">
        <view class="media-icon"></view>
      </view>

      <!-- 消息输入框 -->
      <input 
        class="message-input" 
        value="{{messageInput}}" 
        bindinput="onMessageInput" 
        bindconfirm="sendMessage"
        placeholder="输入消息..." 
        placeholder-style="color: #71717a;"
        confirm-type="send"
        cursor-spacing="10"
        adjust-position="{{true}}"
        hold-keyboard="{{true}}"
      />

      <!-- 发送按钮 -->
      <button 
        class="send-button {{(!messageInput && !mediaFile) ? 'disabled' : ''}}" 
        bindtap="sendMessage" 
        disabled="{{!messageInput && !mediaFile}}"
        hover-class="button-hover"
      >
        <view class="send-icon"></view>
        <text class="send-button-text">发送</text>
        <view class="send-button-ripple"></view>
      </button>
    </view>
  </view>
</view> 