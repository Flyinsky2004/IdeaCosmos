<!-- 聊天页面 -->
<view class="chat-container">
  <!-- 侧边栏切换按钮 - 移到外部确保始终可见 -->
  <view class="sidebar-toggle" bindtap="toggleSidebar">
    <text class="iconfont {{isExpanded ? 'icon-collapse' : 'icon-expand'}}"></text>
  </view>
  
  <!-- 侧边栏 -->
  <view class="sidebar {{isExpanded ? 'expanded' : 'collapsed'}}">
    <view class="sidebar-header">
      <!-- 侧边栏切换按钮已移到外部 -->
    </view>

    <scroll-view scroll-y class="chat-list">
      <view 
        wx:for="{{chatHistory}}" 
        wx:key="ID" 
        class="chat-item {{currentChatId === item.ID ? 'active' : ''}}"
        bindtap="loadChatHistory" 
        data-id="{{item.ID}}"
      >
        <text class="iconfont icon-message"></text>
        <view wx:if="{{isExpanded}}" class="chat-item-content">
          <text class="chat-title">{{item.title}}</text>
          <text class="chat-time">{{item.formattedTime}}</text>
          <view class="delete-btn" catchtap="showDeleteConfirm" data-id="{{item.ID}}">
            <text class="iconfont icon-delete"></text>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 主聊天区域 -->
  <view class="main-area">
    <!-- 顶部栏 -->
    <view class="top-bar">
      <view class="menu-btn" bindtap="toggleSidebar">
        <text class="iconfont icon-menu"></text>
      </view>
      <text class="chat-title">{{currentChat.title || '新对话'}}</text>
      <button class="new-chat-btn" bindtap="createNewChat">新对话</button>
    </view>

    <!-- 消息列表 -->
    <scroll-view 
      scroll-y 
      class="message-list" 
      scroll-into-view="{{scrollToMessage}}"
      enhanced="true"
      show-scrollbar="false"
      scroll-anchoring="true"
    >
      <view class="messages-container">
        <view 
          wx:for="{{messages}}" 
          wx:key="index" 
          id="msg-{{index}}" 
          class="message {{item.role === 'user' ? 'message-user' : 'message-ai'}}"
        >
          <view class="avatar">
            <image 
              src="{{item.role === 'user' ? userInfo.avatarUrl || '/assets/images/default-avatar.png' : '/assets/images/logo.png'}}" 
              mode="aspectFill"
            />
          </view>
          <view class="message-bubble">
            <rich-text wx:if="{{item.role !== 'user'}}" nodes="{{item.formattedContent}}" />
            <text wx:else>{{item.content}}</text>
          </view>
        </view>

        <!-- 加载动画 -->
        <view wx:if="{{isGenerating}}" class="typing-indicator">
          <view class="dot"></view>
          <view class="dot"></view>
          <view class="dot"></view>
        </view>
      </view>
    </scroll-view>

    <!-- 输入区域 -->
    <view class="input-area">
      <view class="input-container">
        <textarea 
          class="message-input"
          value="{{newMessage}}"
          bindinput="onInputChange"
          placeholder="输入消息..."
          auto-height
          maxlength="-1"
          cursor-spacing="20"
          fixed="true"
          show-confirm-bar="{{false}}"
          adjust-position="{{false}}"
        />
        <button 
          class="send-button {{newMessage.trim() ? 'active' : ''}}"
          bindtap="sendMessage"
          disabled="{{!newMessage.trim() || isGenerating}}"
        >
          <text class="iconfont icon-send"></text>
        </button>
      </view>
    </view>
  </view>
</view>

<!-- 删除确认弹窗 -->
<view class="modal" wx:if="{{showDeleteModal}}">
  <view class="modal-content">
    <view class="modal-header">删除对话</view>
    <view class="modal-body">确定要删除这个对话吗？此操作不可恢复。</view>
    <view class="modal-footer">
      <button class="modal-btn cancel" bindtap="cancelDelete">取消</button>
      <button class="modal-btn confirm" bindtap="confirmDelete">删除</button>
    </view>
  </view>
</view>
